name: Build and Upload Lambdas

on:
  push:
    branches:
      - main
  pull_request:
    branches: [ "main" ]


jobs:
  build-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm install

      - name: Package Lambdas
        run: |
          mkdir -p dist
          for lambda in lambdas/*; do
            name=$(basename $lambda)
            echo "ðŸ“¦ Packaging $name"
            cp -r node_modules "$lambda/"
            zip -r "dist/$name.zip" "$lambda"
            rm -rf "$lambda/node_modules"
          done

      - name: Configure AWS Credentials ðŸ”‘
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1 # Use the region where your S3 bucket resides

      - name: Upload All Lambdas to S3 ðŸš€
        # Using the AWS CLI (which is pre-installed on the runner) to sync the 'dist' folder.
        # The 'sync' command is best practice for deployment as it only uploads new/changed files.
        run: |
          aws s3 sync ./dist/ s3://lambda-code-tc3/ \
            --exclude "*" \
            --include "*.zip" 
            
          echo "âœ… All zip files uploaded to s3://lambda-code-tc3/"
      # --- END: New/Corrected AWS Steps ---





